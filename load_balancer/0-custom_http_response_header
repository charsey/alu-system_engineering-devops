#!/usr/bin/env bash
# This script configures an Ubuntu machine with Nginx and sets a custom HTTP response header.

# Ensure the script is run as root
if [ "$EUID" -ne 0 ]; then
  echo "Please run as root"
  exit
fi

# Update and install Nginx
echo "Updating package list and upgrading system..."
apt-get update && apt-get upgrade -y

echo "Installing Nginx..."
apt-get install -y nginx

# Get the current hostname
hostname=$(hostname)

# Create a custom Nginx configuration file
echo "Configuring Nginx to include the X-Served-By header..."
cat > /etc/nginx/conf.d/custom_headers.conf <<EOF
server {
    listen 80 default_server;
    server_name _;

    location / {
        add_header X-Served-By $hostname;
        # Optional: A simple response for verification
        return 200 'Welcome to $hostname!';
        add_header Content-Type text/plain;
    }
}
EOF

# Remove the default Nginx configuration if it exists
if [ -f /etc/nginx/sites-enabled/default ]; then
  echo "Removing default Nginx site configuration..."
  rm /etc/nginx/sites-enabled/default
fi

# Test and apply the configuration
echo "Testing Nginx configuration..."
nginx -t

echo "Restarting Nginx to apply changes..."
systemctl restart nginx

# Output completion message
echo "Configuration complete. Nginx is serving responses with the X-Served-By header."

