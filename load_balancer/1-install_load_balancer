#!/usr/bin/env bash
# Script to configure Nginx with a custom HTTP response header and set hostname

# Update the system and install Nginx
sudo apt-get update -y
sudo apt-get install -y nginx

# Set the hostname based on the specific student ID
if [[ $(hostname) != "618120744-web-01" && $(hostname) != "618120744-web-02" ]]; then
    if [[ $1 == "web-01" ]]; then
        sudo hostnamectl set-hostname 618120744-web-01
    elif [[ $1 == "web-02" ]]; then
        sudo hostnamectl set-hostname 618120744-web-02
    else
        echo "Error: Please specify 'web-01' or 'web-02' as an argument."
        exit 1
    fi
fi

# Ensure proper permissions for /var/www/html
sudo mkdir -p /var/www/html
sudo chmod -R 755 /var/www/html
sudo chown -R www-data:www-data /var/www/html

# Create a test HTML page that includes the hostname
echo "<html>
<head>
    <title>Welcome</title>
</head>
<body>
    This is a test page served by $(hostname).
</body>
</html>" | sudo tee /var/www/html/index.html > /dev/null

# Add custom HTTP response header in Nginx configuration
if ! grep -q "add_header X-Served-By" /etc/nginx/sites-enabled/default; then
    sudo sed -i '/server {/a \\n    add_header X-Served-By \"$hostname\";' /etc/nginx/sites-enabled/default
fi

# Test and reload Nginx configuration
sudo nginx -t
if [[ $? -eq 0 ]]; then
    sudo service nginx reload
else
    echo "Nginx configuration test failed."
    exit 1
fi

